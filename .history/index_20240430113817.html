<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.bootcss.com/pako/1.0.6/pako.min.js"></script>

    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 0px;
        }
    </style>

    <title>Android Yata组件化性能测试报告</title>

</head>

<body onload="main()">
    <h2>Android Yata组件化性能测试报告</h2>

    <div id="grid-container" class="grid"></div>

    <script>
        function main() {
            const params = new URLSearchParams(window.location.search);
            const paramsObject = Object.fromEntries(params);

            const paramDataArray = decode(paramsObject["data"])

            for (var i = 0; i < paramDataArray.length; i++) {
                const paramData = paramDataArray[i];
                handleSingleSceneDuration(paramData);
            }
        }

        function decode(gzipStr) {
            // 将gzip字符串转换为Uint8Array类型的数据
            const gzipData = new Uint8Array(atob(gzipStr).split('').map(char => char.charCodeAt(0)));

            // 解压gzip数据
            const uncompressedData = pako.inflate(gzipData, { to: 'string' });
            return uncompressedData
        }

        function handleSingleSceneDuration(paramData) {
            const durationType = [
                "yata_store_tree_build_timing_duration",
                "yata_store_tree_update_timing_duration",
                "yata_view_upscreen_timing_duration"
            ];

            for (var i = 0; i < durationType.length; i++) {
                let type = durationType[i];
                console.log('print type:-----' + type);
                let durationData = paramData[type];
                console.log('data' + durationData);
                let title = paramData['biz_code'] + '_' + paramData['scene'] + '_' + type;
                drawChart(convertToCN(title), durationData);
            }
        }

        function drawChart(title, durationData) {
            //整理数据     
            let dataArray = [];
            Object.keys(durationData).forEach(key => {
                let yValue = durationData[key];
                let xValue = [];
                for (let i = 1; i <= yValue.length; i++) {
                    xValue.push(i);
                }
                dataArray.push({
                    x: xValue,
                    y: yValue,
                    type: 'line',
                    name: key
                })
            });

            //画图
            let container = document.getElementById('grid-container');
            //region addView
            let div = document.createElement('div');
            let viewId = "chart" + title;
            div.id = viewId;
            container.appendChild(div);
            Plotly.newPlot(viewId, dataArray, layout = {
                xaxis: {
                    title: title
                },
                yaxis: {
                    title: "耗时/ms"
                }
            })
        }

        function convertToCN(content) {
            return content
                .replace('yata_sku', 'SKU')
                .replace('yata_order_list', '订单')
                .replace('yata_buynow', '提单')
                .replace('yata_cart', '购物车')
                .replace('yata_skubuy', '极致提单')
                .replace('biz_first_enter', '首屏')
                .replace('biz_diff_refresh', '差量刷新')
                .replace('yata_store_tree_build_timing_duration', '全量建树')
                .replace('yata_store_tree_update_timing_duration', '差量建树')
                .replace('yata_view_upscreen_timing_duration', '渲染')
        }
    </script>
</body>

</html>